;--------------------------
; Clear any previous SDE model
;--------------------------
(sde:clear)  ; Reset the SDE environment, removing any existing geometry or doping

;--------------------------
; Set process orientation
;--------------------------
(sde:set-process-up-direction "+z")  ; Define the up direction for all subsequent layer definitions

;--------------------------
; Enable Boolean operations by default
;--------------------------
(sdegeo:set-default-boolean "BAB")  ; Use Boolean Add/Subtract operations for region stitching

;############# Definition of Parameters #############

;-- Horizontal (lateral) dimensions (in microns)
(define Xmax      @Xmax@)    ; Total half-cell width of the IGBT
(define Wgate     1.8)       ; Width of the gate electrode (emitter aperture)
(define Wnplus    0.5)       ; Width of the n+ cathode-short region
(define Wpplus    1.5)       ; Width of the p+ pocket implants on either side of the gate
(define Wemitter  1.8)       ; Lateral extent of the emitter contact region

;-- Vertical (depth) dimensions (in microns)
(define Ymax       100.0)    ; Total device depth (substrate bottom to surface)
(define Ygate       5.0)     ; Vertical height of the gate poly above the surface
(define Ypplus      0.5)     ; Depth of the p+ pocket implants
(define Ynplus      0.5)     ; Depth of the n+ cathode-short implant
(define Ypbase     @Ypbase@)  ; Depth of the P-base region (profile edge)
(define Hnbuffer   @Hnbuffer@) ; Depth of the n-buffer (field-stop) layer
(define Hcollector   0.5)    ; Depth of the p+ collector (anode) implant

;-- Doping concentrations (in atoms/cm^3; placeholders  will be replaced)
(define Ndrift     @Ndrift@)   ; Lightly doped drift layer
(define Pbase      @Pbase@)    ; Peak concentration of the P-base Gaussian
(define Pplus      1e19)  ; Boron for p+ pockets 
(define Nplus      1e19 ) ; Phosphorus for n+ regions (1x10^19)
(define Nbuffer    @Nbuffer@ ) ; Peak concentration of n-buffer (field-stop)
(define Pcollector 1e17 )  ; Boron for p+ collector (1x10^17)

;Gate oxide sidewall and bottom thickness (in microns)
(define Tox_sidewall 0.1)      ; Oxide thickness on the trench sidewalls
(define Tox_bottom   0.12)     ; Oxide thickness under the gate bottom

;-- Fillet radius and gate angle utilities
(define R           0.3)       ; Radius for corner fillets in polygons
(define gate_angle  89.0)      ; Gate slope angle (degrees)
(define TAN (tan (* (/ gate_angle 180) PI)))  ; Precompute tangent
(define COS (cos (* (/ gate_angle 180) PI)))  ; Precompute cosine (unused)
(define SIN (sin (* (/ gate_angle 180) PI)))  ; Precompute sine (unused)

;############# Build the Gate Stack #############

; Loop over one cell repeat (i = 0 to <1)
(do
  ((i 0 (+ i 1)))      ; Initialize i=0, increment by 1
  ((= i 1))            ; Exit after i == 1
  (begin
    ;-------- Poly-Silicon Gate Electrode --------
    (define Region1 (string-append "region1." (number->string i)))
    (sdegeo:create-polygon
      (list
        (position (+ (* i 6) Wpplus Wnplus Tox_sidewall)          0.0 0)
        (position (+ (* i 6) Wpplus Wnplus Tox_sidewall Wgate)   0.0 0)
        (position (- (+ (* i 6) Wpplus Wnplus Tox_sidewall Wgate) (/ Ygate TAN)) Ygate 0)
        (position (+ (* i 6) Wpplus Wnplus Tox_sidewall (/ Ygate TAN))  Ygate 0)
        (position (+ (* i 6) Wpplus Wnplus Tox_sidewall)           0.0 0)
      )
      "PolySi" Region1)  ; Material: Polysilicon, tag Region1

    ; Fillet the two top corners of the gate for smoother mesh
    (sdegeo:fillet-2d
      (list
        (car
          (find-vertex-id
            (position (- (+ (* i 6) Wpplus Wnplus Tox_sidewall Wgate) (/ Ygate TAN)) Ygate 0)
          )
        )
      )
      R)
    (sdegeo:fillet-2d
      (list
        (car
          (find-vertex-id
            (position (+ (* i 6) Wpplus Wnplus Tox_sidewall (/ Ygate TAN)) Ygate 0)
          )
        )
      )
      R)

    ;-------- Gate Oxide Region --------
    (define Region2 (string-append "region2." (number->string i)))
    (sdegeo:create-polygon
      (list
        (position (+ (* i 6) Wpplus Wnplus)                         0.0 0)
        (position (+ (* i 6) Wpplus Wnplus Wgate (* 2 Tox_sidewall)) 0.0 0)
        (position (- (+ (* i 6) Wpplus Wnplus Wgate (* 2 Tox_sidewall)) (/ (+ Ygate Tox_bottom) TAN)) (+ Ygate Tox_bottom) 0)
        (position (+ (* i 6) Wpplus Wnplus (/ (+ Ygate Tox_bottom) TAN)) (+ Ygate Tox_bottom) 0)
        (position (+ (* i 6) Wpplus Wnplus)                         0.0 0)
      )
      "Oxide" Region2)  ; Material: Gate Oxide, tag Region2

    ; Fillet oxide corners
    (sdegeo:fillet-2d
      (list
        (car
          (find-vertex-id
            (position (- (+ (* i 6) Wpplus Wnplus Wgate (* 2 Tox_sidewall)) (/ (+ Ygate Tox_bottom) TAN)) (+ Ygate Tox_bottom) 0)
          )
        )
      )
      R)
    (sdegeo:fillet-2d
      (list
        (car
          (find-vertex-id
            (position (+ (* i 6) Wpplus Wnplus (/ (+ Ygate Tox_bottom) TAN)) (+ Ygate Tox_bottom) 0)
          )
        )
      )
      R)
  )
)

;############# Substrate Definition #############
(sdegeo:create-rectangle
  (position 0.0   0.0   0.0)
  (position Xmax Ymax  0.0)
  "Silicon" "R.Si")  ; Bulk substrate region tag R.Si

;############# Define Contacts #############

; Emitter contacts on left and right of each cell repeat
(do
  ((j 0 (+ j 1)))
  ((= j 1))
  (begin
    ; Left emitter metal
    (sdegeo:create-rectangle
      (position (* j 6)          0.0 0.0)
      (position (+ (* j 6) Wemitter) -0.2 0.0)
      "Aluminum" "R.EmitterLeft")
    ; Right emitter metal
    (sdegeo:create-rectangle
      (position (- (+ (* j 6) 6) Wemitter) 0.0 0.0)
      (position (+ (* j 6) 6)             -0.2 0.0)
      "Aluminum" "R.EmitterRight")
    ; Define and assign Emitter contact
    (sdegeo:define-contact-set "Emitter" 4 (color:rgb 1 0 0) "##")
    (sdegeo:set-contact-boundary-edges
      (list (car (find-body-id (position (+ (* j 6) (/ Wemitter 2.0)) -0.1 0))))
      "Emitter")
    ; Remove the interior overlap region
    (sdegeo:delete-region (find-body-id (position (+ (* j 6) (/ Wemitter 6)) -0.1 0)))
    ; Single emitter contact on right side (alias)
    (sdegeo:set-contact
      (find-body-id (position (- (+ (* j 6) 6) (/ Wemitter 2.0)) -0.1 0))
      "Emitter" "remove")
    ; Define and assign Gate contact
    (sdegeo:define-contact-set "Gate" 4 (color:rgb 0 1 0) "##")
    (sdegeo:set-contact
      (find-body-id
        (position (+ (* j 6) Wpplus Wnplus Tox_sidewall (/ Wgate 2.0)) (/ Ygate 2.0) 0))
      "Gate")
  )
)

; Collector contact at the top center
(sdegeo:define-contact-set "Collector" 4 (color:rgb 0 0 1) "##")
(sdegeo:define-2d-contact
  (find-edge-id (position (/ Xmax 2.0) Ymax 0))
  "Collector")

;############# Define Doping Profiles #############

;-- Drift region (constant n-type)
(sdedr:define-constant-profile  "Constant.Substrate"
  "PhosphorusActiveConcentration" Ndrift)
(sdedr:define-constant-profile-material "PLConstant.Substrate"
  "Constant.Substrate" "Silicon")

;-- Polysilicon gate (heavily doped n-type)
(sdedr:define-constant-profile  "Constant.PolySilicon"
  "PhosphorusActiveConcentration" 1000000000000000000000)  ; 1x10^21
(sdedr:define-constant-profile-material "PLConstant.PolySilicon"
  "Constant.PolySilicon" "PolySilicon" 0.0 "Replace")

;-- P-base Gaussian implant along bottom line from x=0 to Xmax
(sdedr:define-refeval-window "RW.BaselinePbase" "Line"
  (position 0.0 0.0 0.0)
  (position Xmax 0.0 0.0))
(sdedr:define-gaussian-profile "Gauss.Pbase"
  "BoronActiveConcentration"
  "PeakPos"     0.0
  "PeakVal"     Pbase
  "ValueAtDepth" Ndrift
  "Depth"       Ypbase
  "Gauss"       "Factor" 0.7)
(sdedr:define-analytical-profile-placement "PLGauss.Pbase"
  "Gauss.Pbase" "RW.BaselinePbase" "Both" "NoReplace" "Eval")

;-- P+ pockets on left and right of each cell
(do
  ((i 0 (+ i 1)))
  ((= i 1))
  (begin
    ; Left pocket
    (sdedr:define-refeval-window
      (string-append "RW.BaseLineLeftPplus_" (number->string i))
      "Line"
      (position (* i 6) 0.0 0.0)
      (position (+ (* i 6) Wpplus) 0.0 0.0))
    (sdedr:define-gaussian-profile
      (string-append "GAUSS.Pplus_" (number->string i))
      "BoronActiveConcentration"
      "PeakPos"     0.0
      "PeakVal"     Pplus
      "ValueAtDepth" Pbase
      "Depth"       Ypplus
      "Gauss"       "Factor" 0.7)
    (sdedr:define-analytical-profile-placement
      (string-append "PLGauss.LeftPplus_" (number->string i))
      (string-append "GAUSS.Pplus_" (number->string i))
      (string-append "RW.BaseLineLeftPplus_" (number->string i))
      "Both" "NoReplace" "Eval")

    ; Right pocket
    (sdedr:define-refeval-window
      (string-append "RW.BaseLineRightPplus_" (number->string i))
      "Line"
      (position (- (+ (* i 6) 6) Wpplus) 0.0 0.0)
      (position (+ (* i 6) 6) 0.0 0.0))
    (sdedr:define-analytical-profile-placement
      (string-append "PLGauss.RightPplus_" (number->string i))
      (string-append "GAUSS.Pplus_" (number->string i))
      (string-append "RW.BaseLineRightPplus_" (number->string i))
      "Both" "NoReplace" "Eval")
  )
)

;-- N+ cathode-short implants on left and right of each cell
(do
  ((j 0 (+ j 1)))
  ((= j 1))
  (begin
    ; Left n+
    (sdedr:define-refeval-window
      (string-append "RW.BaseLineLeftNplus_" (number->string j))
      "Line"
      (position (+ (* j 6) Wpplus) 0.0 0.0)
      (position (+ (* j 6) Wpplus Wnplus) 0.0 0.0))
    (sdedr:define-gaussian-profile
      (string-append "GAUSS.Nplus_" (number->string j))
      "PhosphorusActiveConcentration"
      "PeakPos"     0.0
      "PeakVal"     Nplus
      "ValueAtDepth" Pbase
      "Depth"       Ynplus
      "Gauss"       "Factor" 0.7)
    (sdedr:define-analytical-profile-placement
      (string-append "PLGauss.LeftNplus_" (number->string j))
      (string-append "GAUSS.Nplus_" (number->string j))
      (string-append "RW.BaseLineLeftNplus_" (number->string j))
      "Both" "NoReplace" "Eval")

    ; Right n+
    (sdedr:define-refeval-window
      (string-append "RW.BaseLineRightNplus_" (number->string j))
      "Line"
      (position (- (+ (* j 6) 6) Wpplus Wnplus) 0.0 0.0)
      (position (- (+ (* j 6) 6) Wpplus)           0.0 0.0))
    (sdedr:define-analytical-profile-placement
      (string-append "PLGauss.RightNplus_" (number->string j))
      (string-append "GAUSS.Nplus_" (number->string j))
      (string-append "RW.BaseLineRightNplus_" (number->string j))
      "Both" "NoReplace" "Eval")
  )
)

;-- n-Buffer (field-stop) layer near the bottom of the drift region
(sdedr:define-refeval-window "RW.BaselineNbuffer" "Line"
  (position 0.0        (- Ymax Hcollector) 0.0)
  (position Xmax       (- Ymax Hcollector) 0.0))
(sdedr:define-gaussian-profile "Gauss.Nbuffer"
  "ArsenicActiveConcentration"
  "PeakPos"     0.0
  "PeakVal"     Nbuffer
  "ValueAtDepth" Ndrift
  "Depth"       Hnbuffer
  "Gauss"       "Factor" 0.7)
(sdedr:define-analytical-profile-placement "PLGauss.Nbuffer"
  "Gauss.Nbuffer" "RW.BaselineNbuffer" "Both" "NoReplace" "Eval")

;-- p+ Collector (anode) implant along the top edge
(sdedr:define-refeval-window "RW.BaselinePcollector" "Line"
  (position 0.0         Ymax 0.0)
  (position Xmax        Ymax 0.0))
(sdedr:define-gaussian-profile "Gauss.Pcollector"
  "BoronActiveConcentration"
  "PeakPos"     0.0
  "PeakVal"     Pcollector
  "ValueAtDepth" Nbuffer
  "Depth"       Hcollector
  "Gauss"       "Factor" 0.7)
(sdedr:define-analytical-profile-placement "PLGauss.Pcollector"
  "Gauss.Pcollector" "RW.BaselinePcollector" "Both" "NoReplace" "Eval")

;############# Mesh Refinement #############

; Global rectangular mesh refinement region
(define RNAME "Global")
(sdedr:define-refeval-window (string-append "RW." RNAME) "Rectangle"
  (position 0.0   0.0   0.0)
  (position 1000  500   0))
(sdedr:define-refinement-size (string-append "RS." RNAME)
  1.0 1.0   0.01 0.01)  ; coarse global resolution
(sdedr:define-refinement-placement (string-append "RP." RNAME)
  (string-append "RS." RNAME) (string-append "RW." RNAME))

; Finer mesh around Silicon regions
(define MNAME "Silicon")
(sdedr:define-refinement-size (string-append "RS." MNAME)
  0.8 0.8 0.01 0.01)
(sdedr:define-refinement-function (string-append "RS." MNAME)
  "DopingConcentration" "MaxTransDiff" 1.0)
(sdedr:define-refinement-material (string-append "RP." MNAME)
  (string-append "RS." MNAME) MNAME)

; Offset based local refinement for curvature and interfaces
(define nlevels 10)
(define factor 1.2)
(do
  ((i 0 (+ i 1)))
  ((= i 1))
  (begin
    (define Region1 (string-append "region1." (number->string i)))
    (define Region2 (string-append "region2." (number->string i)))
    (sdedr:offset-block      "material"  "Silicon" "maxlevel" nlevels)
    (sdedr:offset-interface  "region"    "R.Si"     Region2 "hlocal" 0.001 "factor" factor)
    (sdedr:offset-interface  "region"    Region2     Region1 "hlocal" 0.01  "factor" factor)
    (sdedr:offset-interface  "region"    Region2    "R.Si"   "hlocal" 0.003 "factor" factor)
  )
)

;############# Save and Build Mesh #############
(sde:save-model "n@node@")   ; Save the combined geometry+doping model
(sde:build-mesh "n@node@")   ; Generate the finite element mesh for simulation
